<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard Vision Pro v8.0 | Aldeia</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #030712;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(14, 165, 233, 0.1), transparent 30%),
                radial-gradient(circle at 90% 80%, rgba(13, 148, 136, 0.1), transparent 30%);
            background-attachment: fixed;
        }

        .glass-panel {
            background-color: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .podium-1 { border-color: #FFD700; box-shadow: 0 0 25px rgba(255, 215, 0, 0.4), inset 0 0 10px rgba(255, 215, 0, 0.2); }
        .podium-2 { border-color: #C0C0C0; box-shadow: 0 0 20px rgba(192, 192, 192, 0.3), inset 0 0 10px rgba(192, 192, 192, 0.2); }
        .podium-3 { border-color: #CD7F32; box-shadow: 0 0 20px rgba(205, 127, 50, 0.3), inset 0 0 10px rgba(205, 127, 50, 0.2); }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { 
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards; 
        }

        @keyframes highlight-change {
            0% { background-color: rgba(56, 189, 248, 0.3); transform: scale(1.02); }
            100% { background-color: transparent; transform: scale(1); }
        }
        .highlight-change {
            animation: highlight-change 1.8s ease-out;
        }
        
        .chart-container { position: relative; height: 45vh; width: 100%; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 20px; }
        .tab-active { 
            color: #0ea5e9; 
            background-color: rgba(14, 165, 233, 0.1);
            border-image: linear-gradient(to top, #0ea5e9, transparent) 1;
        }

        .rank-up, .rank-down, .rank-stable {
            font-weight: 700; font-size: 1.1rem; width: 1.5rem; text-align: center;
        }
        .rank-up { color: #22c55e; text-shadow: 0 0 6px rgba(34, 197, 94, 0.7); }
        .rank-down { color: #ef4444; text-shadow: 0 0 6px rgba(239, 68, 68, 0.7); }
        .rank-stable { color: #6b7280; }

        .team-card-winner {
            border-color: #0ea5e9;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.3);
        }
        .filter-btn-active {
            background-color: #0ea5e9;
            color: #ffffff;
            box-shadow: 0 0 12px rgba(14, 165, 233, 0.5);
        }
    </style>
</head>
<body class="text-gray-300">

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <header class="text-center mb-10 fade-in">
            <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 tracking-tight">Leaderboard Vision Pro</h1>
            <p class="text-gray-400 mt-3 text-lg">Centro de Comando da Aldeia</p>
        </header>

        <div class="flex flex-col md:flex-row justify-between items-center mb-8 fade-in gap-4" style="animation-delay: 100ms;">
            <div id="period-filter-container" class="flex flex-wrap items-center justify-center gap-2 glass-panel p-2 rounded-xl">
                <!-- Botões de filtro -->
            </div>
            <div id="countdown-timer" class="text-sm font-medium text-gray-500 flex-shrink-0"></div>
        </div>
        
        <div id="loader" class="text-center py-20">
            <p class="mt-4 text-gray-400 font-medium text-lg">Carregando dados da Aldeia...</p>
        </div>
        
        <div id="content-container" class="hidden">
            <div class="mb-12 fade-in" style="animation-delay: 200ms;">
                <h2 class="text-3xl font-bold text-white text-center mb-6">Competição de Times</h2>
                <div id="team-competition-summary" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Cards dos times -->
                </div>
            </div>

            <div class="mb-8 fade-in" style="animation-delay: 300ms;">
                <div id="tabs-container" class="flex items-center border-b-2 border-gray-800">
                    <button data-ranking="value" class="tab-btn tab-active px-5 py-3 font-semibold border-b-2 transition-colors duration-300">Ranking por Depósito</button>
                    <button data-ranking="activation" class="tab-btn px-5 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Ranking por Ativações</button>
                    <button data-ranking="general" class="tab-btn px-5 py-3 font-semibold border-b-2 border-transparent text-gray-400 hover:text-white transition-colors duration-300">Ranking Geral</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12 fade-in" style="animation-delay: 400ms;">
                <div id="team-dollar-gods" class="glass-panel p-6 rounded-2xl"></div>
                <div id="team-elite-squad" class="glass-panel p-6 rounded-2xl"></div>
            </div>

            <div class="fade-in" style="animation-delay: 500ms;">
                <div class="mb-4">
                     <h2 class="text-3xl font-bold text-white">Análise Financeira</h2>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="glass-panel p-6 rounded-2xl flex items-center gap-4">
                        <div class="bg-blue-500/10 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-400"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path></svg></div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Depósito Total (Período)</h3>
                            <p id="kpi-deposito-total" class="text-3xl font-bold text-blue-400 mt-1">$0.00</p>
                        </div>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl flex items-center gap-4">
                        <div class="bg-teal-500/10 p-3 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-400"><polyline points="20 6 9 17 4 12"></polyline></svg></div>
                        <div>
                            <h3 class="text-sm font-medium text-gray-400">Total de Ativações (Período)</h3>
                            <p id="kpi-ativacoes-total" class="text-3xl font-bold text-teal-400 mt-1">0</p>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-6 rounded-2xl">
                     <h3 class="text-lg font-semibold text-white mb-4">Depósito vs. Capital Líquido (Período)</h3>
                     <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                     </div>
                </div>
            </div>
        </div>
        
        <footer class="text-center mt-16 text-sm text-gray-600">
            <p>Leaderboard Vision Pro v8.0</p>
        </footer>
    </div>

    <script>
    (function() {
        // --- CONFIG ---
        const urlDoWebhookN8N = 'https://aldeia2.app.n8n.cloud/webhook/afe90f44-77d3-4a28-afa6-fb26d616299d';
        const UPDATE_INTERVAL_SECONDS = 30;
        const TEAMS = {
            'DOLLAR GODS': ['Felipe', 'Natan', 'Allison', 'João', 'Raul', 'Otavio'],
            'ELITE SQUAD': ['Luan', 'Victor', 'G. Dias', 'G. Wagner', 'Ruan', 'Arthur', 'Laurence', 'Davi']
        };
        const BROKER_MAP = {
            'Felipe Enos': 'Felipe', 'João Lucas': 'João', 'Gabriel Dias': 'G. Dias', 'Gabriel Wagner': 'G. Wagner',
            'Luan Felipe': 'Luan', 'Victor Renan': 'Victor', 'Ruan Neuberger': 'Ruan', 'Arthur De Oliveira': 'Arthur',
            'Laurence Dias': 'Laurence', 'Davi Dias do Nascimento': 'Davi', 'Allison Moreira': 'Allison', 'Otavio': 'Otavio', 'Raul': 'Raul', 'Natan': 'Natan'
        };

        // --- STATE ---
        let rawData = [];
        let mainChartInstance = null;
        let countdownInterval;
        let currentRankingType = 'value';
        let previousRankings = {};
        let currentPeriod = 'all';

        // --- DOM ELEMENTS ---
        const loaderDiv = document.getElementById('loader');
        const contentContainer = document.getElementById('content-container');
        const periodFilterContainer = document.getElementById('period-filter-container');
        const tabsContainer = document.getElementById('tabs-container');
        const teamCompetitionSummary = document.getElementById('team-competition-summary');
        const dollarGodsContainer = document.getElementById('team-dollar-gods');
        const eliteSquadContainer = document.getElementById('team-elite-squad');
        const countdownTimerDiv = document.getElementById('countdown-timer');
        const kpiDeposito = document.getElementById('kpi-deposito-total');
        const kpiAtivacoes = document.getElementById('kpi-ativacoes-total');
        const chartCanvas = document.getElementById('mainChart');

        // --- HELPERS ---
        const getValue = (item, ...keys) => {
            for (const key of keys) if (item[key] !== undefined && item[key] !== null) return item[key];
            return '';
        };
        const parseCurrency = (value) => {
            if (typeof value === 'number') return value;
            if (typeof value === 'string' && value.trim() !== '') return parseFloat(value.replace(/[^\d.,-]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
            return 0;
        };
        const formatCurrency = (value) => value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const getTeamByBroker = (brokerName) => {
            const shortName = BROKER_MAP[brokerName] || brokerName;
            for (const team in TEAMS) if (TEAMS[team].includes(shortName)) return team;
            return 'Sem Time';
        };
        const parseDate = (dateStr) => {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('/');
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]);
            return null;
        };

        // --- DATA PROCESSING ---
        function processData(data, selectedPeriod) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));

            return data.map(item => ({
                ...item,
                parsedDate: parseDate(getValue(item, 'Data Ativação', 'Data Ativacao')),
                team: getTeamByBroker(getValue(item, 'Broker'))
            })).filter(item => {
                if (!item.parsedDate) return selectedPeriod === 'all';
                const itemDate = new Date(item.parsedDate.getFullYear(), item.parsedDate.getMonth(), item.parsedDate.getDate());

                switch(selectedPeriod) {
                    case 'all': return true;
                    case 'today': return itemDate.getTime() === today.getTime();
                    case 'this_week': return itemDate >= startOfWeek && itemDate <= today;
                    default: return `${item.parsedDate.getMonth()}_${item.parsedDate.getFullYear()}` === selectedPeriod;
                }
            });
        }

        function calculateRankings(data) {
            const summary = data.reduce((acc, item) => {
                const shortName = BROKER_MAP[getValue(item, 'Broker')] || getValue(item, 'Broker');
                if (!shortName) return acc;
                
                if (!acc[shortName]) acc[shortName] = { brokerName: shortName, team: item.team, totalDeposito: 0, activationCount: 0 };
                
                acc[shortName].totalDeposito += parseCurrency(getValue(item, 'Depósito', 'Deposito'));
                const ativacao = getValue(item, 'Ativação', 'Ativacao', 'CheckMark');
                if (['Ativação', 'Validado', 'Sim'].includes(ativacao)) acc[shortName].activationCount++;
                return acc;
            }, {});

            const allBrokers = Object.values(summary);
            const valueRanking = [...allBrokers].sort((a, b) => b.totalDeposito - a.totalDeposito);
            const activationRanking = [...allBrokers].sort((a, b) => b.activationCount - a.activationCount);
            
            const maxDeposito = Math.max(...valueRanking.map(b => b.totalDeposito), 1);
            const maxActivations = Math.max(...activationRanking.map(b => b.activationCount), 1);
            allBrokers.forEach(broker => {
                broker.generalScore = ((broker.totalDeposito / maxDeposito) * 60) + ((broker.activationCount / maxActivations) * 40);
            });
            const generalRanking = allBrokers.sort((a, b) => b.generalScore - a.generalScore);
            
            return { valueRanking, activationRanking, generalRanking };
        }
        
        function updatePreviousRankings(rankings) {
            Object.keys(rankings).forEach(type => {
                if (!previousRankings[type]) previousRankings[type] = {};
                rankings[type].forEach((broker, index) => {
                    previousRankings[type][broker.brokerName] = index + 1;
                });
            });
        }

        // --- RENDER FUNCTIONS ---
        function renderTeamCompetition(data) {
            const teamTotals = data.reduce((acc, item) => {
                const team = item.team;
                if(team !== 'Sem Time') {
                    if(!acc[team]) acc[team] = { totalDeposito: 0, activationCount: 0 };
                    acc[team].totalDeposito += parseCurrency(getValue(item, 'Depósito', 'Deposito'));
                    const ativacao = getValue(item, 'Ativação', 'Ativacao', 'CheckMark');
                    if (['Ativação', 'Validado', 'Sim'].includes(ativacao)) acc[team].activationCount++;
                }
                return acc;
            }, {});

            const dg = teamTotals['DOLLAR GODS'] || { totalDeposito: 0, activationCount: 0 };
            const es = teamTotals['ELITE SQUAD'] || { totalDeposito: 0, activationCount: 0 };
            
            const winner = dg.totalDeposito > es.totalDeposito ? 'DOLLAR GODS' : (es.totalDeposito > dg.totalDeposito ? 'ELITE SQUAD' : null);

            teamCompetitionSummary.innerHTML = `
                <div class="team-card glass-panel p-6 rounded-2xl transition-all duration-500 ${winner === 'DOLLAR GODS' ? 'team-card-winner' : ''}">
                    <h3 class="text-2xl font-bold text-white">DOLLAR GODS</h3>
                    <div class="mt-4 space-y-3">
                        <p class="text-lg"><span class="font-semibold text-gray-400">Depósito Total:</span> <span class="font-bold text-blue-400 text-xl">${formatCurrency(dg.totalDeposito)}</span></p>
                        <p class="text-lg"><span class="font-semibold text-gray-400">Ativações:</span> <span class="font-bold text-teal-400 text-xl">${dg.activationCount}</span></p>
                    </div>
                </div>
                <div class="team-card glass-panel p-6 rounded-2xl transition-all duration-500 ${winner === 'ELITE SQUAD' ? 'team-card-winner' : ''}">
                    <h3 class="text-2xl font-bold text-white">ELITE SQUAD</h3>
                    <div class="mt-4 space-y-3">
                        <p class="text-lg"><span class="font-semibold text-gray-400">Depósito Total:</span> <span class="font-bold text-blue-400 text-xl">${formatCurrency(es.totalDeposito)}</span></p>
                        <p class="text-lg"><span class="font-semibold text-gray-400">Ativações:</span> <span class="font-bold text-teal-400 text-xl">${es.activationCount}</span></p>
                    </div>
                </div>
            `;
        }

        function renderTeamRanking(container, teamName, rankingData, rankingType) {
            const teamData = rankingData.filter(b => b.team === teamName);
            let contentHTML = `<h3 class="text-2xl font-bold text-white mb-6">${teamName}</h3>`;

            if (teamData.length === 0) {
                container.innerHTML = contentHTML + `<p class="text-gray-500 text-center py-10">Nenhum dado para este time no período.</p>`;
                return;
            }
            
            let podiumHTML = '<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">';
            teamData.slice(0, 3).forEach((broker, index) => {
                const rank = index + 1;
                let valueText = (rankingType === 'value') ? formatCurrency(broker.totalDeposito) :
                                (rankingType === 'activation') ? `${broker.activationCount} Ativações` :
                                `${broker.generalScore.toFixed(2)} Pontos`;

                podiumHTML += `<div class="podium-${rank} glass-panel p-4 rounded-lg text-center border-2 transform hover:scale-105 transition-transform duration-300">
                    <p class="text-xl font-bold">${rank}º</p>
                    <p class="text-md font-semibold mt-2 truncate text-white">${broker.brokerName}</p>
                    <p class="text-lg font-bold text-gray-300">${valueText}</p>
                </div>`;
            });
            podiumHTML += '</div>';
            
            let listHTML = '<div class="space-y-2 max-h-72 overflow-y-auto custom-scrollbar pr-2">';
            teamData.slice(3).forEach((broker, index) => {
                const rank = index + 4;
                const prevRank = previousRankings[rankingType] ? previousRankings[rankingType][broker.brokerName] : null;
                let rankIndicator = '<span class="rank-stable">-</span>';
                let highlightClass = '';
                if (prevRank) {
                    if (rank < prevRank) rankIndicator = '<span class="rank-up">▲</span>';
                    else if (rank > prevRank) rankIndicator = '<span class="rank-down">▼</span>';
                    if (rank !== prevRank) highlightClass = 'highlight-change';
                }

                let valueText = (rankingType === 'value') ? formatCurrency(broker.totalDeposito) :
                                (rankingType === 'activation') ? `${broker.activationCount} Ativações` :
                                `${broker.generalScore.toFixed(2)} Pontos`;

                listHTML += `<div class="flex items-center glass-panel p-3 rounded-md transition-all duration-300 hover:bg-gray-700/50 ${highlightClass}">
                    <span class="text-sm font-bold text-gray-500 w-8 text-center">${rank}º</span>
                    ${rankIndicator}
                    <span class="font-semibold text-gray-300 flex-1 truncate ml-2">${broker.brokerName}</span>
                    <span class="text-sm font-semibold text-gray-400">${valueText}</span>
                </div>`;
            });
            listHTML += '</div>';
            container.innerHTML = contentHTML + podiumHTML + listHTML;
        }

        function renderAnalysis(data) {
            const totals = data.reduce((acc, item) => {
                acc.deposito += parseCurrency(getValue(item, 'Depósito', 'Deposito'));
                const ativacao = getValue(item, 'Ativação', 'Ativacao', 'CheckMark');
                if (['Ativação', 'Validado', 'Sim'].includes(ativacao)) acc.ativacoes++;
                return acc;
            }, { deposito: 0, ativacoes: 0 });
            kpiDeposito.textContent = formatCurrency(totals.deposito);
            kpiAtivacoes.textContent = totals.ativacoes;

            const summary = data.reduce((acc, item) => {
                const shortName = BROKER_MAP[getValue(item, 'Broker')] || getValue(item, 'Broker');
                if(!acc[shortName]) acc[shortName] = { brokerName: shortName, totalDeposito: 0, totalCapitalLiquido: 0 };
                acc[shortName].totalDeposito += parseCurrency(getValue(item, 'Depósito', 'Deposito'));
                acc[shortName].totalCapitalLiquido += parseCurrency(getValue(item, 'Capital Líquido', 'Capital_Líquido', 'CapitalLiquido', 'Capital Liquido'));
                return acc;
            }, {});
            const chartData = Object.values(summary).sort((a,b) => b.totalCapitalLiquido - a.totalCapitalLiquido);

            if (mainChartInstance) mainChartInstance.destroy();
            Chart.defaults.color = '#9ca3af';
            Chart.defaults.borderColor = 'rgba(55, 65, 81, 0.5)';
            mainChartInstance = new Chart(chartCanvas, {
                type: 'bar',
                data: { labels: chartData.map(d => d.brokerName), datasets: [
                    { label: 'Depósito Total', data: chartData.map(d => d.totalDeposito), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 4 },
                    { label: 'Capital Líquido', data: chartData.map(d => d.totalCapitalLiquido), backgroundColor: 'rgba(20, 184, 166, 0.6)', borderColor: 'rgba(20, 184, 166, 1)', borderWidth: 1, borderRadius: 4 }
                ]},
                options: { responsive: true, maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(55, 65, 81, 0.5)' }, ticks: { callback: v => formatCurrency(v) }}},
                    plugins: { tooltip: { backgroundColor: '#1f2937', titleColor: '#e5e7eb', bodyColor: '#d1d5db', callbacks: { label: c => `${c.dataset.label}: ${formatCurrency(c.parsed.y)}`}}}
                }
            });
        }
        
        function updateDisplay() {
            const filteredData = processData(rawData, currentPeriod);
            const rankings = calculateRankings(filteredData);
            
            let rankingData;
            if (currentRankingType === 'value') rankingData = rankings.valueRanking;
            else if (currentRankingType === 'activation') rankingData = rankings.activationRanking;
            else rankingData = rankings.generalRanking;

            renderTeamCompetition(filteredData);
            renderTeamRanking(dollarGodsContainer, 'DOLLAR GODS', rankingData, currentRankingType);
            renderTeamRanking(eliteSquadContainer, 'ELITE SQUAD', rankingData, currentRankingType);
            renderAnalysis(filteredData);
            updatePreviousRankings(rankings);
        }

        function populateMonthFilter(data) {
            const months = new Set();
            data.forEach(item => {
                const date = parseDate(getValue(item, 'Data Ativação', 'Data Ativacao'));
                if (date) {
                    const monthYear = `${date.getMonth()}_${date.getFullYear()}`;
                    const monthName = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });
                    months.add(JSON.stringify({ value: monthYear, text: monthName.charAt(0).toUpperCase() + monthName.slice(1) }));
                }
            });
            const sortedMonths = Array.from(months).map(m => JSON.parse(m)).sort((a, b) => {
                const [aMonth, aYear] = a.value.split('_'); const [bMonth, bYear] = b.value.split('_');
                return (bYear - aYear) || (bMonth - aMonth);
            });
            
            periodFilterContainer.innerHTML = `
                <button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-semibold transition" data-period="all">Geral</button>
                <button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-semibold transition text-gray-400 hover:bg-gray-700/50" data-period="today">Hoje</button>
                <button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-semibold transition text-gray-400 hover:bg-gray-700/50" data-period="this_week">Esta Semana</button>
            `;
            sortedMonths.forEach(m => periodFilterContainer.innerHTML += `<button class="filter-btn px-4 py-1.5 rounded-lg text-sm font-semibold transition text-gray-400 hover:bg-gray-700/50" data-period="${m.value}">${m.text}</button>`);
        }
        
        function startCountdown() {
            let secondsLeft = UPDATE_INTERVAL_SECONDS;
            clearInterval(countdownInterval);
            const updateTimer = () => {
                countdownTimerDiv.textContent = `Próxima atualização em ${secondsLeft}s...`;
                if(secondsLeft < 0) secondsLeft = UPDATE_INTERVAL_SECONDS;
                secondsLeft--;
            };
            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        async function fetchDataAndUpdate() {
            try {
                const response = await fetch(urlDoWebhookN8N);
                if (!response.ok) throw new Error("Network error");
                const result = await response.json();
                const fullRawData = (Array.isArray(result) && result[0]?.json) ? result[0].json : result;
                if (!Array.isArray(fullRawData)) throw new Error("Invalid data format");
                
                rawData = fullRawData.filter(item => {
                    const date = parseDate(getValue(item, 'Data Ativação', 'Data Ativacao'));
                    if (!date) return false;
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    return year > 2025 || (year === 2025 && month >= 6);
                });

                updateDisplay();
            } catch (error) {
                console.error("Failed to fetch data:", error);
            } finally {
                startCountdown();
            }
        }
        
        async function initialLoad() {
            try {
                const response = await fetch(urlDoWebhookN8N);
                if (!response.ok) throw new Error("Network error");
                const result = await response.json();
                const fullRawData = (Array.isArray(result) && result[0]?.json) ? result[0].json : result;
                if (!Array.isArray(fullRawData)) throw new Error("Invalid data format");

                rawData = fullRawData.filter(item => {
                    const date = parseDate(getValue(item, 'Data Ativação', 'Data Ativacao'));
                    if (!date) return false;
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    return year > 2025 || (year === 2025 && month >= 6);
                });

                populateMonthFilter(rawData);

                const julyOption = periodFilterContainer.querySelector('[data-period="6_2025"]');
                if (julyOption) {
                    currentPeriod = "6_2025";
                } else {
                    currentPeriod = "all";
                }
                
                const activeButton = periodFilterContainer.querySelector(`[data-period="${currentPeriod}"]`);
                if(activeButton) {
                    periodFilterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                    activeButton.classList.add('filter-btn-active');
                }

                const rankings = calculateRankings(processData(rawData, currentPeriod));
                updatePreviousRankings(rankings);
                updateDisplay();

                loaderDiv.classList.add('hidden');
                contentContainer.classList.remove('hidden');
                
                setInterval(fetchDataAndUpdate, UPDATE_INTERVAL_SECONDS * 1000);
                startCountdown();

            } catch (error) {
                console.error("Failed to load initial data:", error);
                loaderDiv.innerHTML = `<p class="text-red-400">Falha ao carregar dados. Verifique a conexão e o webhook.</p>`;
            }
        }
        
        periodFilterContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.filter-btn');
            if (clickedButton) {
                periodFilterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('filter-btn-active'));
                clickedButton.classList.add('filter-btn-active');
                currentPeriod = clickedButton.dataset.period;
                updateDisplay();
            }
        });

        tabsContainer.addEventListener('click', (e) => {
            const clickedButton = e.target.closest('.tab-btn');
            if (clickedButton) {
                tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
                clickedButton.classList.add('tab-active');
                currentRankingType = clickedButton.dataset.ranking;
                updateDisplay();
            }
        });
        
        initialLoad();
    })();
    </script>
</body>
</html>

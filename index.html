<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Center v10.2: Apex | Aldeia</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-color: #0A0A0F;
            --panel-bg: rgba(15, 18, 32, 0.5);
            --border-color: rgba(56, 73, 117, 0.3);
            --glow-color: #38BDF8;
            --text-primary: #E5E7EB;
            --text-secondary: #9CA3AF;
            --team-dollar-gods: #FFD700;
            --team-elite-squad: #38BDF8;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        #animated-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            background-image: 
                linear-gradient(rgba(56, 189, 248, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(56, 189, 248, 0.1) 1px, transparent 1px);
            background-size: 60px 60px;
            animation: grid-pan 80s linear infinite;
        }

        @keyframes grid-pan {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        #command-center {
            width: 100%;
            max-width: 1600px; /* Aumentado para acomodar 3 colunas */
            height: 90vh;
            max-height: 900px;
            background-color: var(--panel-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 80px rgba(0, 0, 0, 0.6);
            padding: 2rem;
            opacity: 0;
            transform: scale(0.95);
            animation: fadeInPanel 1s ease-out forwards;
        }

        @keyframes fadeInPanel {
            to { opacity: 1; transform: scale(1); }
        }

        .view-slide {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.7s ease-in-out, transform 0.7s ease-in-out;
            transform: translateY(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem 0;
        }
        .view-slide.active { opacity: 1; visibility: visible; transform: translateY(0); }

        @keyframes fadeInChild {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .view-slide.active .fade-in-child { animation: fadeInChild 0.6s ease-out forwards; }
        
        #progress-bar {
            height: 100%;
            background: var(--glow-color);
            transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--glow-color);
            border-radius: 2px;
        }
        
        .filter-btn, .ranking-tab {
            color: var(--text-secondary); 
            background-color: rgba(30, 41, 59, 0.6);
            border: 1px solid transparent;
            transition: all 0.3s ease;
        }
        .filter-btn:hover, .ranking-tab:hover {
            background-color: rgba(55, 65, 81, 0.8);
            color: var(--text-primary);
        }
        .filter-btn-active {
            background-color: var(--glow-color);
            color: #030712 !important;
            font-weight: 600;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4);
        }

        .podium-1 .avatar-ring { border-color: #FFD700; }
        .podium-2 .avatar-ring { border-color: #C0C0C0; }
        .podium-3 .avatar-ring { border-color: #CD7F32; }
        
        .avatar-team-dg { border-color: var(--team-dollar-gods); }
        .avatar-team-es { border-color: var(--team-elite-squad); }


        .rank-up { color: #22c55e; } .rank-down { color: #ef4444; } .rank-stable { color: #6b7280; }
        
        .nav-dots {
            position: absolute;
            bottom: 1.5rem; left: 50%;
            transform: translateX(-50%);
            display: flex; gap: 0.75rem;
        }
        .nav-dot {
            width: 10px; height: 10px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-dot:hover { background-color: rgba(255, 255, 255, 0.4); }
        .nav-dot.active { background-color: var(--glow-color); transform: scale(1.2); box-shadow: 0 0 8px var(--glow-color); }
        
        .winning-team {
            transform: scale(1.03);
            border-color: var(--glow-color);
            box-shadow: 0 0 30px rgba(56, 189, 248, 0.3);
        }

        .highlight-change { animation: highlight 1.5s ease-out; }
        @keyframes highlight {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(56, 189, 248, 0.2); }
        }

        /* Scrollbar styles for ranking list */
        .ranking-list::-webkit-scrollbar { width: 4px; }
        .ranking-list::-webkit-scrollbar-track { background: transparent; }
        .ranking-list::-webkit-scrollbar-thumb { background-color: rgba(56, 189, 248, 0.5); border-radius: 20px; }

        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0;
            z-index: 20;
            color: white;
        }
        #command-center:hover .nav-arrow { opacity: 1; }
        .nav-arrow:hover { background-color: rgba(55, 65, 81, 0.8); border-color: var(--glow-color); }
        #prev-slide { left: 0.5rem; }
        #next-slide { right: 0.5rem; }
    </style>
</head>
<body>
    <div id="animated-bg"></div>

    <div id="command-center">
        <!-- Main Content Area with Slides -->
        <main id="slides-container" class="flex-grow relative">
             <!-- SLIDE 1: Team Competition -->
            <div id="view-teams" class="view-slide active">
                <div class="w-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-6 text-center">
                        <h1 class="text-3xl font-bold text-white fade-in-child">Competição de Times</h1>
                    </header>
                    <div id="team-competition-content" class="w-full max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                         <!-- Team cards will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- SLIDE 2: Leaderboard -->
            <div id="view-leaderboard" class="view-slide">
                <div class="w-full h-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-4 text-center">
                        <div id="tabs-container" class="inline-flex bg-black/20 rounded-lg p-1 space-x-1 fade-in-child" style="animation-delay: 100ms;">
                            <!-- Ranking tabs will be rendered here -->
                        </div>
                    </header>
                    <div id="leaderboard-content" class="flex-grow w-full max-w-7xl grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                         <!-- Leaderboard lists will be rendered here -->
                    </div>
                </div>
            </div>
            
            <!-- SLIDE 3: Financial Chart -->
            <div id="view-chart" class="view-slide">
                <div class="w-full h-full flex flex-col items-center">
                    <header class="flex-shrink-0 mb-4 text-center">
                        <h1 class="text-3xl font-bold text-white fade-in-child">Análise Gráfica</h1>
                        <p id="chart-period-title" class="text-gray-400 fade-in-child" style="animation-delay: 100ms;"></p>
                    </header>
                    <div id="chart-content" class="flex-grow relative fade-in-child w-full max-w-5xl h-[400px]" style="animation-delay: 200ms;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>
        </main>

        <!-- Fixed Footer with Controls -->
        <footer class="flex-shrink-0">
            <div id="filter-container" class="mb-4 flex flex-wrap items-center justify-center gap-2">
                <!-- Filtros serão inseridos aqui -->
            </div>
            <div id="nav-dots-container" class="nav-dots"></div>
            <div class="absolute bottom-4 right-4 text-xs text-gray-500 flex items-center gap-3">
                <span id="countdown-timer"></span>
                <button id="refresh-btn" title="Atualizar Agora" class="p-1 rounded-full text-gray-400 hover:bg-white/10 hover:text-white transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                </button>
            </div>
            <div id="progress-bar-container" class="w-full h-1 bg-white/5 absolute bottom-0 left-0 rounded-b-3xl overflow-hidden">
                <div id="progress-bar" style="width: 0%;"></div>
            </div>
        </footer>

        <!-- Navigation Arrows -->
        <button id="prev-slide" class="nav-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
        <button id="next-slide" class="nav-arrow">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>

        <div id="loader" class="absolute inset-0 flex items-center justify-center bg-black/80 rounded-3xl z-30">
            <p class="text-gray-300 text-lg">Iniciando Command Center...</p>
        </div>
    </div>

    <script>
    (() => {
        // --- CONFIG ---
        const urlDoWebhookN8N = 'https://aldeia0225.app.n8n.cloud/webhook/a83cd7e6-b8e4-49ea-b524-9780b993c9ad';
        const DATA_REFRESH_INTERVAL = 3600 * 1000;
        const VIEW_ROTATION_INTERVAL = 15 * 1000;
        const TEAMS = {
            'DOLLAR GODS': ['Felipe', 'Natan', 'Allison', 'João', 'Raul', 'Otavio', 'Lucas Vinicius'],
            'ELITE SQUAD': ['Luan', 'Victor', 'G. Dias', 'G. Wagner', 'Ruan', 'Arthur', 'Laurence', 'Davi']
        };
        const BROKER_MAP = {
            'Felipe Pauluk': 'Felipe', 'Felipe Enos': 'Felipe', 'João Lucas': 'João', 'Gabriel Dias': 'G. Dias', 'Gabriel Wagner': 'G. Wagner',
            'Luan Felipe': 'Luan', 'Victor Renan': 'Victor', 'Ruan Neuberger': 'Ruan', 'Arthur De Oliveira': 'Arthur',
            'Laurence Dias': 'Laurence', 'Davi Dias do Nascimento': 'Davi', 'Allison Moreira': 'Allison', 'Otavio': 'Otavio', 'Raul': 'Raul', 'Natan': 'Natan',
            'Lucas Vinicius': 'Lucas'
        };

        // --- STATE ---
        let rawData = [], mainChartInstance = null;
        let dataRefreshIntervalId, countdownIntervalId, rotationTimeoutId, animationFrameId;
        let rotationStartTime, rotationRemainingTime = VIEW_ROTATION_INTERVAL;
        let currentRankingType = 'value', currentPeriod = '', currentViewIndex = 0;
        let previousRankings = {}, isPaused = false;
        
        const views = ['view-teams', 'view-leaderboard', 'view-chart'];
        const DOM = {
            commandCenter: document.getElementById('command-center'),
            loader: document.getElementById('loader'),
            slides: views.map(id => document.getElementById(id)),
            progressBar: document.getElementById('progress-bar'),
            filterContainer: document.getElementById('filter-container'),
            tabsContainer: document.getElementById('tabs-container'),
            dotsContainer: document.getElementById('nav-dots-container'),
            chartPeriodTitle: document.getElementById('chart-period-title'),
            teamContent: document.getElementById('team-competition-content'),
            leaderboardContent: document.getElementById('leaderboard-content'),
            countdownTimer: document.getElementById('countdown-timer'),
            refreshBtn: document.getElementById('refresh-btn'),
            prevBtn: document.getElementById('prev-slide'),
            nextBtn: document.getElementById('next-slide'),
        };
        
        // --- HELPERS ---
        const getValue = (item, ...keys) => { for (const key of keys) if (item?.[key] != null) return item[key]; return ''; };
        const parseCurrency = (value) => { if (typeof value === 'number') return value; if (typeof value === 'string' && value.trim() !== '') return parseFloat(value.replace(/[^\d.,-]/g, '').replace(/\./g, '').replace(',', '.')) || 0; return 0; };
        const formatCurrency = (value) => value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        const getTeamByBroker = (brokerName) => { const shortName = BROKER_MAP[brokerName] || brokerName; for (const team in TEAMS) if (TEAMS[team].includes(shortName)) return team; return 'Sem Time'; };
        const parseDate = (dateStr) => { 
            if (!dateStr || typeof dateStr !== 'string') return null; 
            // Handle YYYY-MM-DD format from webhook
            if (dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) return new Date(parts[0], parts[1] - 1, parts[2]);
            }
            // Handle DD/MM/YYYY format
            const parts = dateStr.split('/'); 
            if (parts.length === 3) return new Date(parts[2], parts[1] - 1, parts[0]); 
            return null; 
        };
        
        // --- VIEW & SLIDE LOGIC ---
        function showView(index, isManual = false) {
            DOM.slides.forEach((slide, i) => slide.classList.toggle('active', i === index));
            document.querySelectorAll('.nav-dot').forEach((dot, i) => dot.classList.toggle('active', i === index));
            currentViewIndex = index;
            if (isManual) {
                clearTimeout(rotationTimeoutId);
                cancelAnimationFrame(animationFrameId);
                rotationRemainingTime = VIEW_ROTATION_INTERVAL;
                if (!isPaused) startRotation();
            }
        }
        function nextView(isManual = false) { showView((currentViewIndex + 1) % views.length, isManual); }
        function prevView() { showView((currentViewIndex - 1 + views.length) % views.length, true); }
        
        function updateProgressBar() {
            if (isPaused) return;
            const elapsedTime = Date.now() - rotationStartTime;
            const progress = (elapsedTime / rotationRemainingTime) * 100;
            DOM.progressBar.style.width = `${Math.min(progress, 100)}%`;
            animationFrameId = requestAnimationFrame(updateProgressBar);
        }
        
        function startRotation() {
            if (isPaused) return;
            rotationStartTime = Date.now();
            cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(updateProgressBar);
            rotationTimeoutId = setTimeout(() => {
                nextView();
                rotationRemainingTime = VIEW_ROTATION_INTERVAL;
                startRotation();
            }, rotationRemainingTime);
        }
        function pauseRotation() { if (isPaused) return; isPaused = true; clearTimeout(rotationTimeoutId); cancelAnimationFrame(animationFrameId); const elapsedTime = Date.now() - rotationStartTime; rotationRemainingTime -= elapsedTime; }
        function resumeRotation() { if (!isPaused) return; isPaused = false; startRotation(); }
        
        // --- DATA PROCESSING ---
        function processData(data, selectedPeriod) {
            const now = new Date(); const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
            return data.map(item => ({ ...item, parsedDate: parseDate(getValue(item, 'Data')), team: getTeamByBroker(getValue(item, 'Nome')) }))
                .filter(item => {
                    if (!item.parsedDate) return selectedPeriod === 'all'; const itemDate = new Date(item.parsedDate.getFullYear(), item.parsedDate.getMonth(), item.parsedDate.getDate());
                    switch (selectedPeriod) {
                        case 'all': return true; case 'today': return itemDate.getTime() === today.getTime(); case 'this_week': return itemDate >= startOfWeek && itemDate <= today;
                        default: return `${item.parsedDate.getMonth()}_${item.parsedDate.getFullYear()}` === selectedPeriod;
                    }
                });
        }
        function calculateRankings(data) {
            const summary = data.reduce((acc, item) => { 
                const shortName = BROKER_MAP[getValue(item, 'Nome')] || getValue(item, 'Nome'); 
                if (!shortName) return acc; 
                if (!acc[shortName]) acc[shortName] = { brokerName: shortName, team: item.team, totalDeposito: 0, activationCount: 0 }; 
                acc[shortName].totalDeposito += parseCurrency(getValue(item, 'Valor Depósito')); 
                const ativacao = getValue(item, 'Ativação?'); 
                if (ativacao === 'Ativação') acc[shortName].activationCount++; 
                return acc; 
            }, {});
            const allBrokers = Object.values(summary); const valueRanking = [...allBrokers].sort((a, b) => b.totalDeposito - a.totalDeposito); const activationRanking = [...allBrokers].sort((a, b) => b.activationCount - a.activationCount); const maxDeposito = Math.max(...valueRanking.map(b => b.totalDeposito), 1); const maxActivations = Math.max(...activationRanking.map(b => b.activationCount), 1); allBrokers.forEach(broker => { broker.generalScore = ((broker.totalDeposito / maxDeposito) * 0.6) + ((broker.activationCount / maxActivations) * 0.4); }); const generalRanking = allBrokers.sort((a, b) => b.generalScore - a.generalScore);
            return { valueRanking, activationRanking, generalRanking };
        }
        
        // --- RENDER FUNCTIONS ---
        function renderAll() {
            const periodText = document.querySelector(`.filter-btn[data-period="${currentPeriod}"]`)?.textContent || 'Período Atual';
            const filteredData = processData(rawData, currentPeriod);
            const rankings = calculateRankings(filteredData);
            
            DOM.chartPeriodTitle.textContent = periodText;
            renderTeamCompetition(filteredData);
            let rankingData = rankings.valueRanking;
            if (currentRankingType === 'activation') rankingData = rankings.activationRanking;
            else if (currentRankingType === 'general') rankingData = rankings.generalRanking;
            
            renderLeaderboard(rankingData, currentRankingType);
            renderAnalysisChart(filteredData);
            updatePreviousRankings(rankings);
        }
        function updatePreviousRankings(rankings) { Object.keys(rankings).forEach(type => { const rankMap = new Map(rankings[type].map((b, i) => [b.brokerName, i + 1])); previousRankings[type] = rankMap; }); }

        function renderTeamCompetition(data) {
            const kpis = data.reduce((acc, item) => {
                if (!acc[item.team]) acc[item.team] = { totalDeposito: 0, activationCount: 0 };
                acc[item.team].totalDeposito += parseCurrency(getValue(item, 'Valor Depósito'));
                if (getValue(item, 'Ativação?') === 'Ativação') acc[item.team].activationCount++;
                return acc;
            }, {});
            const dg = kpis['DOLLAR GODS'] || { totalDeposito: 0, activationCount: 0 };
            const es = kpis['ELITE SQUAD'] || { totalDeposito: 0, activationCount: 0 };
            const winner = dg.totalDeposito > es.totalDeposito ? 'DOLLAR GODS' : (es.totalDeposito > dg.totalDeposito ? 'ELITE SQUAD' : null);
            
            DOM.teamContent.innerHTML = `
                <div class="fade-in-child transition-all duration-500 ${winner === 'DOLLAR GODS' ? 'winning-team' : ''}" style="animation-delay: 200ms;">
                    <!-- Added more rounded corners for TV-like command center look -->
                    <div class="bg-black/20 p-8 rounded-3xl h-full border border-transparent backdrop-blur-sm">
                        <h2 class="text-2xl font-bold text-center text-white mb-2">DOLLAR GODS</h2>
                        <p class="text-center font-bold mt-1 h-6 ${winner === 'DOLLAR GODS' ? 'text-yellow-400' : ''}">${winner === 'DOLLAR GODS' ? '🏆 LIDERANDO' : ''}</p>
                        <div class="mt-6 text-center space-y-6">
                            <div class="bg-black/30 p-4 rounded-2xl border border-blue-500/20">
                                <p class="text-4xl font-black text-blue-400">${formatCurrency(dg.totalDeposito)}</p>
                                <p class="text-gray-400 text-sm mt-1">em Depósitos</p>
                            </div>
                            <div class="bg-black/30 p-4 rounded-2xl border border-teal-500/20">
                                <p class="text-4xl font-black text-teal-400">${dg.activationCount}</p>
                                <p class="text-gray-400 text-sm mt-1">Ativações</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="fade-in-child transition-all duration-500 ${winner === 'ELITE SQUAD' ? 'winning-team' : ''}" style="animation-delay: 300ms;">
                    <!-- Added more rounded corners for TV-like command center look -->
                    <div class="bg-black/20 p-8 rounded-3xl h-full border border-transparent backdrop-blur-sm">
                        <h2 class="text-2xl font-bold text-center text-white mb-2">ELITE SQUAD</h2>
                        <p class="text-center font-bold mt-1 h-6 ${winner === 'ELITE SQUAD' ? 'text-yellow-400' : ''}">${winner === 'ELITE SQUAD' ? '🏆 LIDERANDO' : ''}</p>
                        <div class="mt-6 text-center space-y-6">
                            <div class="bg-black/30 p-4 rounded-2xl border border-blue-500/20">
                                <p class="text-4xl font-black text-blue-400">${formatCurrency(es.totalDeposito)}</p>
                                <p class="text-gray-400 text-sm mt-1">em Depósitos</p>
                            </div>
                            <div class="bg-black/30 p-4 rounded-2xl border border-teal-500/20">
                                <p class="text-4xl font-black text-teal-400">${es.activationCount}</p>
                                <p class="text-gray-400 text-sm mt-1">Ativações</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderSingleRanking(title, data, rankingType, isOverall = false) {
             let contentHTML = `<div class="min-h-0 flex flex-col fade-in-child">
                <!-- Enhanced title styling for command center look -->
                <div class="bg-black/30 p-3 rounded-2xl mb-4 border border-gray-700/30">
                    <h3 class="text-xl font-bold text-white text-center">${title}</h3>
                </div>`;
             if (data.length === 0) {
                 contentHTML += `<div class="bg-black/20 rounded-2xl flex-grow flex items-center justify-center border border-gray-700/20"><p class="text-gray-500">Nenhum dado.</p></div></div>`;
             } else {
                 let listHTML = '<div class="space-y-3 overflow-y-auto flex-grow pr-2 ranking-list">';
                 data.forEach((broker, index) => {
                     const rank = index + 1;
                     const prevRank = previousRankings[rankingType]?.get(broker.brokerName);
                     let rankIndicator = '<span class="rank-stable text-lg w-6 text-center">-</span>';
                     let highlightClass = '';
                     if (prevRank) { 
                         if (rank < prevRank) rankIndicator = '<span class="rank-up text-lg w-6 text-center">▲</span>'; 
                         else if (rank > prevRank) rankIndicator = '<span class="rank-down text-lg w-6 text-center">▼</span>'; 
                         if (rank !== prevRank) highlightClass = 'highlight-change'; 
                     }
                     let valueText = (rankingType === 'value') ? formatCurrency(broker.totalDeposito) : (rankingType === 'activation') ? `${broker.activationCount} Ativações` : `${broker.generalScore.toFixed(2)} pts`;
                     const initials = broker.brokerName.split(' ').map(n => n[0]).join('').substring(0,2);
                     const teamColorClass = isOverall ? (broker.team === 'DOLLAR GODS' ? 'avatar-team-dg' : 'avatar-team-es') : '';
                     listHTML += `<div class="flex items-center bg-black/30 p-3 rounded-2xl transition duration-300 ${highlightClass} border border-gray-700/20 hover:border-gray-600/40">
                         <span class="text-lg font-bold text-gray-300 w-10 text-center bg-black/40 rounded-xl py-1">${rank}º</span>
                         <div class="w-11 h-11 rounded-2xl bg-gray-700 flex items-center justify-center font-bold text-sm text-white mx-3 border-2 avatar-ring ${rank <= 3 && isOverall ? `podium-${rank}`: ''} ${teamColorClass}">${initials}</div>
                         <span class="font-semibold text-gray-200 flex-1 truncate">${broker.brokerName}</span>
                         ${rankIndicator}
                         <span class="text-sm font-semibold text-gray-300 ml-2 w-32 text-right bg-black/40 px-2 py-1 rounded-xl">${valueText}</span>
                     </div>`;
                 });
                 listHTML += '</div>';
                 contentHTML += listHTML + '</div>';
             }
             return contentHTML;
        }

        function renderLeaderboard(rankingData, rankingType) {
            const dollarGodsData = rankingData.filter(b => b.team === 'DOLLAR GODS');
            const eliteSquadData = rankingData.filter(b => b.team === 'ELITE SQUAD');

            DOM.leaderboardContent.innerHTML = 
                renderSingleRanking('DOLLAR GODS', dollarGodsData, rankingType) +
                renderSingleRanking('RANKING GERAL', rankingData, rankingType, true) +
                renderSingleRanking('ELITE SQUAD', eliteSquadData, rankingType);
        }


        function renderAnalysisChart(data) {
             const summary = data.reduce((acc, item) => {
                const shortName = BROKER_MAP[getValue(item, 'Nome')] || getValue(item, 'Nome');
                if(!acc[shortName]) acc[shortName] = { brokerName: shortName, totalDeposito: 0, depositoCount: 0 };
                const depositoValor = parseCurrency(getValue(item, 'Valor Depósito'));
                if (depositoValor > 0) { acc[shortName].totalDeposito += depositoValor; acc[shortName].depositoCount++; }
                return acc;
            }, {});
            const chartData = Object.values(summary).sort((a,b) => b.totalDeposito - a.totalDeposito).slice(0, 15);

            const existingChart = Chart.getChart('mainChart');
            if (existingChart) {
                existingChart.destroy();
            }

            Chart.defaults.color = '#9ca3af';
            mainChartInstance = new Chart('mainChart', {
                type: 'bar',
                data: { 
                    labels: chartData.map(d => d.brokerName), 
                    datasets: [
                        { label: 'Valor Total Depositado', data: chartData.map(d => d.totalDeposito), backgroundColor: 'rgba(56, 189, 248, 0.6)', yAxisID: 'y' },
                        { label: 'Quantidade de Depósitos', data: chartData.map(d => d.depositoCount), type: 'line', borderColor: 'rgba(20, 184, 166, 1)', tension: 0.3, yAxisID: 'y1', pointBackgroundColor: '#06b6d4', pointRadius: 4 }
                ]},
                options: { responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { type: 'linear', display: true, position: 'left', beginAtZero: true, grid: { color: 'rgba(55, 65, 81, 0.5)' }, ticks: { callback: v => formatCurrency(v) }},
                        y1: { type: 'linear', display: true, position: 'right', beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { stepSize: 1, precision: 0 } }
                    },
                    plugins: { tooltip: { backgroundColor: '#1f2937', callbacks: { label: c => { let l = c.dataset.label || ''; if(l) l += ': '; if(c.dataset.yAxisID === 'y') l += formatCurrency(c.parsed.y); else l += c.parsed.y; return l; }}}}
                }
            });
        }
        
        // --- INITIALIZATION ---
        function initialize() {
            DOM.loader.textContent = 'Buscando dados iniciais...';
            fetchDataAndUpdate(true);
            dataRefreshIntervalId = setInterval(() => fetchDataAndUpdate(false), DATA_REFRESH_INTERVAL);
        }

        function populateFilters(data) {
            const months = new Set();
            data.forEach(item => { const date = parseDate(getValue(item, 'Data')); if (date) { const my = `${date.getMonth()}_${date.getFullYear()}`; const mn = date.toLocaleString('pt-BR', { month: 'long', year: 'numeric' }); months.add(JSON.stringify({ value: my, text: mn.charAt(0).toUpperCase() + mn.slice(1) })); } });
            const sortedMonths = Array.from(months).map(m => JSON.parse(m)).sort((a, b) => { const [am, ay] = a.value.split('_'); const [bm, by] = b.value.split('_'); return (by - ay) || (bm - am); });
            
            DOM.filterContainer.innerHTML = `
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold border border-gray-700/30" data-period="all">Geral</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold border border-gray-700/30" data-period="today">Hoje</button>
                <button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold border border-gray-700/30" data-period="this_week">Esta Semana</button>
                ${sortedMonths.map(m => `<button class="filter-btn px-4 py-2 rounded-xl text-sm font-semibold border border-gray-700/30" data-period="${m.value}">${m.text}</button>`).join('')}
            `;
            DOM.tabsContainer.innerHTML = `
                <button data-ranking="value" class="ranking-tab px-5 py-2 text-sm font-semibold rounded-xl transition border border-gray-700/30">Depósitos</button>
                <button data-ranking="activation" class="ranking-tab px-5 py-2 text-sm font-semibold rounded-xl transition border border-gray-700/30">Ativações</button>
                <button data-ranking="general" class="ranking-tab px-5 py-2 text-sm font-semibold rounded-xl transition border border-gray-700/30">Geral</button>
            `;
            DOM.dotsContainer.innerHTML = views.map((_, i) => `<div class="nav-dot" data-index="${i}"></div>`).join('');
        }

        function updateActiveFiltersAndTabs() {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('filter-btn-active', btn.dataset.period === currentPeriod));
            document.querySelectorAll('.ranking-tab').forEach(btn => btn.classList.toggle('filter-btn-active', btn.dataset.ranking === currentRankingType));
        }
        
        function setupEventListeners() {
            if (DOM.filterContainer) DOM.filterContainer.addEventListener('click', e => { if (e.target.matches('.filter-btn')) { currentPeriod = e.target.dataset.period; updateActiveFiltersAndTabs(); renderAll(); } });
            if (DOM.tabsContainer) DOM.tabsContainer.addEventListener('click', e => { if (e.target.matches('.ranking-tab')) { currentRankingType = e.target.dataset.ranking; updateActiveFiltersAndTabs(); renderAll(); } });
            if (DOM.dotsContainer) DOM.dotsContainer.addEventListener('click', e => { if (e.target.matches('.nav-dot')) { showView(parseInt(e.target.dataset.index), true); } });
            if (DOM.nextBtn) DOM.nextBtn.addEventListener('click', () => nextView(true));
            if (DOM.prevBtn) DOM.prevBtn.addEventListener('click', prevView);
            if (DOM.refreshBtn) DOM.refreshBtn.addEventListener('click', () => fetchDataAndUpdate(false));
            if (DOM.commandCenter) {
                DOM.commandCenter.addEventListener('mouseenter', pauseRotation);
                DOM.commandCenter.addEventListener('mouseleave', resumeRotation);
            }
        }

        async function fetchDataAndUpdate(isInitial) {
             DOM.countdownTimer.textContent = "Atualizando...";
             try {
                const response = await fetch(urlDoWebhookN8N); if (!response.ok) throw new Error("Network error");
                const result = await response.json(); const fullRawData = (Array.isArray(result) && result[0]?.json) ? result[0].json : result;
                if (!Array.isArray(fullRawData)) throw new Error("Invalid data format");
                rawData = fullRawData.filter(item => { const date = parseDate(getValue(item, 'Data')); if (!date) return false; const year = date.getFullYear(); const month = date.getMonth(); return year > 2025 || (year === 2025 && month >= 6); });
                
                if (isInitial) {
                    populateFilters(rawData);
                    const augustOption = document.querySelector('[data-period="7_2025"]');
                    currentPeriod = augustOption ? "7_2025" : "all";
                }
                updateActiveFiltersAndTabs();
                const rankings = calculateRankings(processData(rawData, currentPeriod));
                if (Object.keys(previousRankings).length === 0) { updatePreviousRankings(rankings); }
                renderAll();
             } catch(error) { console.error("Fetch failed:", error); DOM.loader.textContent = 'Erro ao carregar dados.'; return; }
             
             if (isInitial) { 
                 DOM.loader.style.display = 'none'; 
                 setupEventListeners(); 
                 showView(0); 
                 startRotation(); 
             }
             
             clearInterval(countdownIntervalId);
             let secondsLeft = DATA_REFRESH_INTERVAL / 1000;
             const updateTimer = () => {
                 secondsLeft--;
                 if(secondsLeft < 0) secondsLeft = 0;
                 const minutes = Math.floor(secondsLeft / 60); const seconds = secondsLeft % 60;
                 DOM.countdownTimer.textContent = `Atualiza em ${minutes}m ${seconds.toString().padStart(2, '0')}s`;
             };
             updateTimer();
             countdownIntervalId = setInterval(updateTimer, 1000);
        }

        initialize();
    })();
    </script>
</body>
</html>
